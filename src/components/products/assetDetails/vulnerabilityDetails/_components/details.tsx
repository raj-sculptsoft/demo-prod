import { Card } from "@/components/ui/card";
import { Textarea } from "@/components/ui/textarea";
import { DetailsProps, ImpactLevel } from "@/types/vulnerability";
import AnalysisChart from "./analysis-chart";
import RiskMatrix from "./risk-matrix";
import StatsCard from "./stats-card";

export default function Details({
  id,
  impact,
  severity,
  cwe,
  cve,
  description,
  recommendation,
  confidence_score,
  positivity,
  likelihood,
  exploitability,
  vulnerability,
}: DetailsProps) {
  const toCapitalizedImpactLevel = (
    value: ImpactLevel,
  ): "Critical" | "High" | "Medium" | "Low" => {
    // Mapping ensures consistent capitalization of impact levels
    const mapping: Record<ImpactLevel, "Critical" | "High" | "Medium" | "Low"> =
      {
        critical: "Critical",
        high: "High",
        medium: "Medium",
        low: "Low",
        Critical: "Critical",
        High: "High",
        Medium: "Medium",
        Low: "Low",
      };
    return mapping[value];
  };

  const capitalizeFirstLetter = (str: string) => {
    // Capitalizes only the first letter and converts the rest to lowercase
    return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
  };

  // Assign default values if CVE or CWE is empty or "N/A"
  if (cve == "" || cve == "N/A") {
    cve = "No CVE assigned";
  }

  if (cwe == "" || cwe == "N/A") {
    cwe = "No CWE assigned";
  }

  return (
    <Card>
      <div className="border-b p-4">
        <h3 className="mb-3 text-lg font-bold">{vulnerability}</h3>
        <p>ID: {id}</p>
      </div>
      <div className="p-4 pb-2">
        <div className="grid grid-cols-1 gap-8 border-b pb-3 lg:grid-cols-2">
          <div className="space-y-5">
            <div className="grid grid-cols-1 gap-6 md:grid-cols-2">
              <AnalysisChart
                key="impact"
                title="Impact"
                value={toCapitalizedImpactLevel(impact)}
              />
              <AnalysisChart
                key="severity"
                title="Severity"
                value={toCapitalizedImpactLevel(severity)}
              />
            </div>
            <div className="grid grid-cols-1 gap-6 md:grid-cols-2">
              <StatsCard
                title="CWE"
                description={cwe ?? "No CWE assigned"}
                showShare={!!cwe}
              />
              <StatsCard
                title="CVE"
                description={cve ?? "No CVE assigned"}
                showShare={!!cve && cve !== "No CVE assigned"}
              />
              {!positivity && (
                <StatsCard
                  title="False Positive"
                  description={`False Positive :- ${confidence_score?.toString() + "%" || "N/A"}`}
                />
              )}
            </div>
          </div>

          <RiskMatrix
            likelihood={capitalizeFirstLetter(likelihood)}
            impact={toCapitalizedImpactLevel(impact)}
          />
        </div>
        <div className="space-y-3 pb-3 pt-5 text-base text-borderColor-dark">
          <p>
            <span className="font-bold">Exploitability:</span> {exploitability}
          </p>

          <div>
            <p className="font-bold">Description</p>
            <Textarea
              readOnly
              className="resize-none text-base"
              value={description}
            />
          </div>

          <p>
            <span className="font-bold">Recommendation:</span> {recommendation}
          </p>
        </div>
      </div>
    </Card>
  );
}
